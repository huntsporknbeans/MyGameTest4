
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chibi Catch ‚Äì Jan & Chewie</title>
  <style>
    :root{ --panel:rgba(255,255,255,.92); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background:#0b0b0b; color:#111; display:grid; place-items:center; overflow:hidden; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    canvas{ width:min(96vw, 960px); height:auto; aspect-ratio: 3/2; image-rendering: pixelated; background:#000; border:4px solid #000; border-radius:12px; display:block; }
    .overlay{ position:fixed; inset:0; display:grid; place-items:center; }
    .card{ background:var(--panel); color:#111; border:3px solid #000; border-radius:14px; padding:18px 22px; box-shadow:0 10px 30px rgba(0,0,0,.5); text-align:center; }
    .title{ font-size:clamp(22px,3.2vw,32px); font-weight:800; letter-spacing:.5px; margin:0 0 .2em; }
    .sub{ margin:.2em 0 1em; opacity:.8 }
    .row{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap }
    button{ cursor:pointer; border:3px solid #000; border-radius:12px; background:#ffd44d; padding:10px 16px; font-weight:800; box-shadow:0 2px 0 #000; }
    button:active{ transform:translateY(1px); box-shadow:0 1px 0 #000; }
    /* Mobile controls */
    #controls{ position:fixed; left:0; right:0; bottom:16px; display:flex; justify-content:space-between; padding:0 24px; pointer-events:none; }
    .btn{ width:80px; height:80px; border-radius:50%; background:rgba(0,0,0,.55); color:#fff; border:2px solid #fff; display:grid; place-items:center; font-size:30px; user-select:none; pointer-events:auto }
    #centerBtn{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px }
    .help{ position:fixed; top:10px; right:10px; background:var(--panel); border:2px solid #000; border-radius:10px; padding:6px 10px; font-size:12px }
  </style>
</head>
<body>
  <canvas id="game" width="480" height="320"></canvas>

  <!-- Start / Win overlays -->
  <div class="overlay" id="startOverlay">
    <div class="card">
      <h1 class="title">Chibi Catch üíñ</h1>
      <p class="sub">Move <b>Jan</b> with ‚Üê ‚Üí. Catch 20 falling hearts!<br/>Control <b>Chewie</b> with A/D, or tap/click him / press üê∂.</p>
      <div class="row"><button id="startBtn">Start</button></div>
    </div>
  </div>

  <div class="overlay" id="winOverlay" style="display:none">
    <div class="card">
      <h1 class="title" style="color:#e11">I LOVE YOU ‚ù§Ô∏è</h1>
      <p class="sub">You caught them all!</p>
      <div class="row"><button id="restartBtn">Restart</button></div>
    </div>
  </div>

  <!-- Mobile controls -->
  <div id="controls">
    <div id="leftBtn" class="btn">‚¨ÖÔ∏è</div>
    <div id="rightBtn" class="btn">‚û°Ô∏è</div>
  </div>
  <div id="centerBtn" class="btn">üê∂</div>

  <div class="help">Keys: ‚Üê/‚Üí Jan ‚Ä¢ A/D Chewie ‚Ä¢ Click/Tap Chewie to animate</div>

  <script>
  // === ASSETS (same folder as this HTML) ===
  const ASSETS = {
    jan: 'jan_sprite.png',            // 3 frames horizontally
    chewie: 'chewie_sprite.png',      // 4 frames horizontally
    heart: 'heart.png',
    background: 'background.png',
    sfx: { catch: 'catch.wav', win: 'win.wav', music: 'loopB.wav' }
  };

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');

  // --- Robust preload to avoid drawImage InvalidStateError ---
  let imgBG, imgJan, imgChewie, imgHeart;
  let assetsReady = false;
  let loadProgress = 0;
  const TOTAL_IMAGES = 4;

  function loadImage(src){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      img.addEventListener('load', ()=>{ loadProgress++; resolve(img); });
      img.addEventListener('error', (e)=>{ console.error('Failed to load image:', src, e); reject(e); });
      img.decoding = 'async';
      img.src = src;
    });
  }

  function drawLoading(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#111'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#fff'; ctx.font='16px Arial';
    ctx.fillText('Loading assets‚Ä¶ '+loadProgress+'/'+TOTAL_IMAGES, 12, 24);
    ctx.strokeStyle = '#fff'; ctx.strokeRect(12, 36, canvas.width-24, 12);
    ctx.fillStyle = '#fff'; ctx.fillRect(12, 36, ((canvas.width-24)*(loadProgress/TOTAL_IMAGES))|0, 12);
    if(!assetsReady) requestAnimationFrame(drawLoading);
  }

  // --- Audio (unlocked on first interaction) ---
  const sfxCatch = new Audio(ASSETS.sfx.catch);
  const sfxWin = new Audio(ASSETS.sfx.win);
  const bgMusic = new Audio(ASSETS.sfx.music); bgMusic.loop = true; bgMusic.volume = 0.6;

  // --- Game constants/state ---
  const TOTAL_HEARTS = 20;                // must catch exactly 20
  const HEART_SPEED = 60;                 // px/s
  const JAN_SPEED = 160;
  const CHEWIE_SPEED = 80;
  let gameState = 'start';                // start, playing, win
  let score = 0;
  let hearts = [];
  let shower = [];                         // celebration particles
  let showerActive = false;
  let showerEndTime = 0;                   // stop spawning after 3s; each particle fades by 5s

  // --- Entities ---
  const jan = { x: 200, y: 256, w:32, h:32, frame:0, frameTimer:0 };
  const chewie = { x: 350, y: 256, w:32, h:32, frame:0, frameTimer:0, idleTimer:0, overrideTimer:0 };

  // Chewie idle cycle: stand(0) -> wag-left(2) -> stand(0) -> wag-right(3)
  const IDLE_SEQ = [0,2,0,3];
  let idleIndex = 0;

  // --- Input ---
  const keys = {};
  document.addEventListener('keydown', e=>keys[e.key]=true);
  document.addEventListener('keyup', e=>keys[e.key]=false);

  function bindBtn(id, onDown, onUp){
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('touchstart', e=>{e.preventDefault(); onDown()});
    el.addEventListener('touchend', e=>{e.preventDefault(); onUp&&onUp()});
    el.addEventListener('mousedown', onDown);
    el.addEventListener('mouseup', onUp||(()=>{}));
  }
  let holdLeft=false, holdRight=false;
  bindBtn('leftBtn', ()=>holdLeft=true, ()=>holdLeft=false);
  bindBtn('rightBtn', ()=>holdRight=true, ()=>holdRight=false);
  bindBtn('centerBtn', ()=>triggerChewie(), null);

  // Start/Restart buttons (also unlock audio policies)
  document.getElementById('startBtn').addEventListener('click', startGame);
  document.getElementById('restartBtn').addEventListener('click', startGame);

  // Click/tap chewie to animate quickly
  canvas.addEventListener('click', (e)=>{
    const {left, top} = canvas.getBoundingClientRect();
    const mx = (e.clientX - left) * (canvas.width / canvas.clientWidth);
    const my = (e.clientY - top) * (canvas.height / canvas.clientHeight);
    if(pointIn(mx,my, chewie)) triggerChewie();
  });
  canvas.addEventListener('touchstart', (e)=>{
    const t = e.touches[0]; if(!t) return;
    const {left, top} = canvas.getBoundingClientRect();
    const mx = (t.clientX - left) * (canvas.width / canvas.clientWidth);
    const my = (t.clientY - top) * (canvas.height / canvas.clientHeight);
    if(pointIn(mx,my, chewie)) triggerChewie();
  });

  function pointIn(px,py, r){ return px>=r.x && px<=r.x+r.w && py>=r.y && py<=r.y+r.h }

  function startGame(){
    score = 0; hearts.length = 0; shower.length = 0; showerActive = false;
    gameState = 'playing';
    document.getElementById('startOverlay').style.display='none';
    document.getElementById('winOverlay').style.display='none';

    // position characters
    jan.x = 200; chewie.x = 350; jan.frame=0; chewie.frame=0;

    // spawn 20 hearts staggered vertically
    for(let i=0;i<TOTAL_HEARTS;i++){
      hearts.push({ x: 20 + Math.random()*440, y: -Math.random()*600 - i*25, w:20, h:20, caught:false });
    }
    try{ bgMusic.currentTime = 0; bgMusic.play(); }catch(err){}
  }

  function triggerChewie(){
    // 0: stand, 1: belly-up, 2: wag-left, 3: wag-right
    chewie.overrideTimer = 0.8; // seconds of fast cycle override
  }

  // --- Loop (starts only after assetsReady) ---
  let last = performance.now();
  function loop(now){
    if(!assetsReady){ return; }
    const dt = Math.min(0.05, (now-last)/1000); // clamp 50ms
    last = now;
    update(dt); draw();
    requestAnimationFrame(loop);
  }

  function update(dt){
    if(gameState!=='playing') return;

    // Move Jan ‚Äì Arrow keys or mobile buttons
    let moving = false;
    if(keys['ArrowLeft']||holdLeft){ jan.x -= JAN_SPEED*dt; moving=true; }
    if(keys['ArrowRight']||holdRight){ jan.x += JAN_SPEED*dt; moving=true; }
    jan.x = Math.max(0, Math.min(canvas.width - jan.w, jan.x));
    // Jan 3-frame walk: 0 idle, 1 walk1, 2 walk2
    if(moving){ jan.frameTimer += dt; if(jan.frameTimer>0.12){ jan.frame=(jan.frame+1)%3; jan.frameTimer=0; } }
    else { jan.frame=0; jan.frameTimer=0; }

    // Chewie drift via A/D keys
    if(keys['a']||keys['A']) chewie.x -= CHEWIE_SPEED*dt;
    if(keys['d']||keys['D']) chewie.x += CHEWIE_SPEED*dt;
    chewie.x = Math.max(0, Math.min(canvas.width - chewie.w, chewie.x));

    // Chewie animation
    if(chewie.overrideTimer>0){
      chewie.overrideTimer -= dt;
      chewie.frameTimer += dt;
      if(chewie.frameTimer>0.08){ chewie.frame = (chewie.frame+1)%4; chewie.frameTimer = 0; }
    } else {
      // Idle cycle: stand/wag-left/stand/wag-right
      chewie.idleTimer += dt;
      if(chewie.idleTimer>0.35){ chewie.idleTimer=0; idleIndex=(idleIndex+1)%IDLE_SEQ.length; chewie.frame = IDLE_SEQ[idleIndex]; }
    }

    // Hearts falling & catching
    for(const h of hearts){
      if(h.caught) continue;
      h.y += HEART_SPEED * dt;
      if(aabb(h, jan)){
        h.caught = true; score++; try{ sfxCatch.currentTime=0; sfxCatch.play(); }catch(err){}
        if(score>=TOTAL_HEARTS){
          gameState='win';
          try{ bgMusic.pause(); sfxWin.play(); }catch(err){}
          startShower();
        }
      }
      if(h.y>canvas.height){ h.y = -20; h.x = 20 + Math.random()*440; }
    }

    // Win shower particles
    if(showerActive){
      for(const p of shower){
        p.vy += 10*dt; p.y += p.vy * dt; p.life -= dt; p.alpha = Math.max(0, p.life/5);
      }
      shower = shower.filter(p=>p.life>0 && p.y<canvas.height+30);
      // spawn new hearts for first 3 seconds
      if(performance.now() < showerEndTime){ spawnShowerBurst(8); }
      // After ~5s total, show restart (ensure message stays)
      if(performance.now() > showerEndTime + 2000){ document.getElementById('winOverlay').style.display='grid'; }
    }
  }

  function draw(){
    if(!assetsReady){ return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(imgBG,0,0,canvas.width,canvas.height);

    // Score
    ctx.fillStyle = '#000'; ctx.font = '16px Arial'; ctx.fillText(`Caught: ${score}/${TOTAL_HEARTS}` ,10,20);

    // Hearts
    for(const h of hearts){ if(!h.caught) ctx.drawImage(imgHeart, h.x, h.y, h.w, h.h); }

    // Draw Chewie first so Jan can overlap
    drawSprite(imgChewie, chewie.frame, 4, chewie.x, chewie.y, chewie.w, chewie.h);
    // Draw Jan
    drawSprite(imgJan, jan.frame, 3, jan.x, jan.y, jan.w, jan.h);

    // Celebration hearts
    if(showerActive){
      for(const p of shower){
        ctx.globalAlpha = p.alpha;
        ctx.drawImage(imgHeart, p.x, p.y, p.size, p.size);
      }
      ctx.globalAlpha = 1;
    }

    if(gameState==='start'){
      document.getElementById('startOverlay').style.display='grid';
    }
  }

  function aabb(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }
  function drawSprite(img, frame, framesAcross, x,y,w,h){
    const fw = (img.width/framesAcross)|0; const fh = img.height|0;
    const sx = Math.max(0, Math.min(framesAcross-1, Math.floor(frame))) * fw;
    ctx.drawImage(img, sx, 0, fw, fh, x, y, w, h);
  }

  // --- Celebration helpers ---
  function startShower(){
    showerActive = true;
    showerEndTime = performance.now() + 3000; // spawn for first 3s
    for(let i=0;i<24;i++) spawnShowerBurst(6); // initial burst
  }
  function spawnShowerBurst(n){
    for(let i=0;i<n;i++){
      const size = 10 + Math.random()*18;
      shower.push({ x: Math.random()*canvas.width, y: -20, vy: 50+Math.random()*120, size, life:5, alpha:1 }); // fade over 5s
    }
  }

  // --- Kick off preloading then main loop ---
  function preload(){
    drawLoading();
    Promise.all([
      loadImage(ASSETS.background).then(i=>imgBG=i),
      loadImage(ASSETS.jan).then(i=>imgJan=i),
      loadImage(ASSETS.chewie).then(i=>imgChewie=i),
      loadImage(ASSETS.heart).then(i=>imgHeart=i)
    ]).then(()=>{
      assetsReady = true;
      requestAnimationFrame(loop);
    }).catch(()=>{
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#fff'; ctx.font = '16px Arial';
      ctx.fillText('‚ö†Ô∏è Failed to load images. Place files next to this HTML.', 10, 24);
    });
  }

  // Start the preload
  preload();
  </script>
</body>
</html>
  
